<!doctype html>
<html>

<head>
    <title>React Single Page Starter</title>
    <script src="https://unpkg.com/react@15.3.2/dist/react.js"></script>
    <script src="https://unpkg.com/react-dom@15.3.2/dist/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>

    <style>
        body {
            font-family: Helvetica;
            font-size: 18px;
        }

        .title{
            color: darkblue;
        }

    </style>
</head>

<body>
    <div id="app">
        <!-- App -->
    </div>

    <!-- JavaScript -->
    <script type="text/babel">


        // --------------------------------
        // Simple Component

        // A simple component is just a function that returns JSX.
        // A simple component takes a props object as an argument
        // that contains values used to configure the component.

        // --------------------------------
        const Title = (props) => {
            return (
                <div className='title'>
                    <h1>{props.title}</h1>
                    <h2>{props.subtitle}</h2>
                </div>
            );
        }
        // --------------------------------






        // --------------------------------
        // List
        // --------------------------------

        // These things will be displayed in the list.
        const things = [{name: "Alison", age:21}, {name: "Billy", age:17}, {name: "Charlie", age:18}];

        // This component will display a list of items provided by an array
        // on props. Best practice, transform the array into an array of JSX!
        // React will render the entire list if given an array of JSX items.
        // Each item should have a unique key value!

        const List = (props) => {
          const items = props.items.map((person, index) => {
            return (
                <li key={index}>
                    <Title title={person.name} subtitle={person.age}/>
                </li>
            );
          });

          return (
            <ul>
              {items}
            </ul>
          );
        }
        // ----------------------------------






        // --------------------------------
        // Stateful Component

        // A stateful component is defined as a class. The class below
        // uses the ES6 style of class definition.
        // A stateful component must provide a render method that returns
        // JSX.
        // It's constructor takes in a props object with values to configure
        // the component.
        // The component can define a state object that contains values the
        // component uses to define it's "state". Values on state should be
        // changed by calling setState( obj ) with an object containing new
        // values. Changing values in this way will cause the component to
        // rerender! You can see this in the example below in the tick()
        // method. Here the date property on state is changed by calling
        // setState() and passing an updated value. This causes the render
        // method to update and display the new time.

        // Notice the time to display is passed to the Title component
        // as title this causes the Title component to render and it receives
        // props.title which it displays.

        // --------------------------------
        class Clock extends React.Component {
            constructor(props) {
                super(props);
                this.state = {
                    date: new Date(),
                    isOn: true
                };
                this.timerId = setInterval(() => this.tick(), 1000);
            }

            componentWillUnmount() {
                clearInterval(this.timerId);
            }

            tick() {
                this.setState({date: new Date()});
            }

            render() {
                const date = this.state.date;
                const h = date.getHours();
                const m = date.getMinutes();
                const s = date.getSeconds();
                const year = date.getFullYear();

                const displayTime = `${h}:${m}:${s}`;
                return (
                    <Title title="React Timer" subtitle="Counts in seconds" time={displayTime}/>
                );
            }
        }
        // --------------------------------
        //
        // class Timer extends React.Component{
        //     constructor(props){
        //         super(props);
        //         this.state = {
        //             isRunning: false,
        //             time: 0
        //         };
        //         // this.start.bind(this);
        //         this.toggleRun.bind(this);
        //     }
        //
        //     toggleRun(){
        //         this.setState({isRunning: !this.state.isRunning}, () => {
        //             // If it's running, set new timer
        //             this.state.isRunning ? this.start() : clearInterval(this.timer);
        //         })
        //     }
        //
        //     start(){
        //         console.log("Testing", Date.now());
        //         this.startTime = Date.now();
        //         console.log("Testing2", Date.now(), this.startTime);
        //         this.timer = setInterval(() => this.tick(), 500)
        //     }
        //
        //     tick(){
        //         let runtime = Date.now() - this.startTime;
        //         console.log("Ticking")
        //         this.setState({time: this.state.time + runtime});
        //     }
        //
        //     render() {
        //         const seconds = this.state.time % 1000;
        //         return(
        //             <div>
        //                 <Title title="Timer" subtitle={seconds}/>
        //                 <button onClick={this.toggleRun}>Start</button>
        //             </div>
        //         );
        //     }
        // }

        class Timer extends React.Component{
            constructor(props){
                super(props);
                this.state = {
                    isRunning: false,
                    time: 0
                };
                this.toggle = this.toggle.bind(this);
                this.reset = this.reset.bind(this);

            }

            componentWillUnmount() {
                clearInterval(this.timerId);
            }

            toggle() {
                this.setState({isRunning: !this.state.isRunning}, () =>{
                    if(this.state.isRunning){
                        // The offset allows us to leave off where we started
                        this.startTime = Date.now() - this.state.time;
                        this.timerId = setInterval(() => this.tick(), 100);
                    }
                    else{
                        // Stop the ongoing interval to freeze timer
                        clearInterval(this.timerId);
                    }

                })
            }

            reset(){
                clearInterval(this.timerId);
                this.setState({time: 0, isRunning: false});
            }

            tick() {
                this.setState({time: Date.now() - this.startTime});
            }

            render() {
                const seconds = (this.state.time / 1000) % 60;
                const minutes = seconds / 60;
                const formattedTime = timeFormat(this.state.time)

                // console.log(formattedTime)
                const state = this.state.isRunning;
                return(
                    <div>
                        <Title title="Timer" subtitle={formattedTime}/>
                        <button onClick={this.toggle}>
                            {state ? 'Stop' : 'Start'}
                        </button>
                        <button onClick={this.reset}>
                            Reset
                        </button>
                    </div>
                );
            }
        }

        const timeFormat = (time) => {
            const seconds = time / 1000
            let fmilli, secString;
            let fseconds = Math.floor(seconds % 60, 2);
            let fminutes = Math.floor(seconds / 60, 2);
            if(seconds < 10){
                secString = "0" + fseconds;
                fmilli = seconds.toFixed(3).substring(2);
            }
            else{
                secString = String(fseconds);
                fmilli = seconds.toFixed(3).substring(3);

            }

            console.log(fmilli, seconds)
            return `${fminutes}:${secString}.${fmilli}`

        };



        // --------------------------------
        // Renders reacts virtual DOM.
        // --------------------------------

        // This handles displaying the React stuff in the browser.
        // Each of the react components is rendered as standard HTML
        // at this stage.

        ReactDOM.render(
            <div>
                <Title title="Simple React Starter" />
                <Clock />
                <List items={things} />
                <Timer />

            </div>,
            document.getElementById('app')
        );
    </script>
</body>
</html>
